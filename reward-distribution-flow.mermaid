sequenceDiagram
    participant RP as 報酬提供者
    participant Admin as 管理者/オペレーター
    participant BE as バックエンド
    participant DB as データベース
    participant BC as ブロックチェーン
    participant User as ユーザー
    participant FE as フロントエンド
    participant Wallet as ウォレット

    %% Airdrop設定フェーズ
    rect rgb(230, 240, 255)
      note over Admin, BC: Airdrop設定フェーズ
      Admin->>BC: registerAirdrop(airdropId, startDate, endDate, isActive)
      BC->>BC: airdrops[airdropId] = {isActive, startDate, endDate, creator: msg.sender}
      BC-->>BE: AirdropCreatedイベント発行
      BE->>BE: イベント検知
      BE->>DB: Airdrop情報保存
      BE-->>Admin: 設定完了通知
    end

    %% 報酬設定フェーズ
    rect rgb(255, 240, 240)
      note over RP, BE: 報酬設定フェーズ
      RP->>BC: registerRewardWithAirdrop(assetId, airdropId, recipient, amount, tokenId)
      BC->>BC: Airdropの有効性チェック
      BC->>BC: 報酬情報登録＆コミットメント保存
      BC-->>BE: RewardRegisteredイベント発行
      BE->>BE: イベント検知
      BE->>DB: 報酬情報を保存
      BE-->>RP: 登録完了通知
    end

    %% 報酬表示フェーズ
    rect rgb(255, 255, 240)
      note over User, FE: 報酬表示フェーズ
      User->>FE: 報酬一覧ページにアクセス
      FE->>BE: 報酬情報リクエスト(userAddress)
      BE->>DB: ユーザー向け報酬をクエリ
      BE->>BC: オンチェーンの取得状態確認
      BC-->>BE: 各報酬の取得状態(claimed)
      BE->>BE: DB状態とブロックチェーン状態を同期
      BE-->>FE: 報酬一覧+取得状態を返却
      FE-->>User: Airdropごとに報酬を表示
    end

    %% 報酬請求準備フェーズ
    rect rgb(240, 255, 240)
      note over User, BE: 報酬請求準備フェーズ
      User->>FE: 報酬請求ボタンをクリック
      FE->>BE: 請求準備リクエスト(chainId, assetId, rewardId, airdropId)
      BE->>BC: isAirdropValid(airdropId)
      BC-->>BE: 有効状態(true/false)
      alt Airdropが無効
        BE-->>FE: エラー「このAirdropは無効です」
        FE-->>User: エラー表示
      else Airdropが有効
        BE->>BC: getNonce(userAddress)
        BC-->>BE: nonce
        BE->>BE: 署名生成(chainId, userAddress, assetId, rewardId, airdropId, nonce)
        BE->>DB: 署名を記録
        BE-->>FE: 署名データとパラメータ返却
      end
    end

    %% 報酬受取フェーズ
    rect rgb(240, 240, 255)
      note over User, BC: 報酬受取フェーズ
      FE->>Wallet: claimReward呼び出し要求
      Wallet->>BC: claimReward(chainId, assetId, rewardId, airdropId, nonce, signature, amount, tokenId)
      BC->>BC: 署名検証
      BC->>BC: Airdrop有効性チェック
      BC->>BC: 報酬コミットメント検証
      BC->>BC: nonce++
      BC->>BC: 報酬を請求済みとしてマーク
      BC->>BC: トークン転送処理
      BC-->>Wallet: トランザクション完了
      BC-->>BE: RewardClaimedイベント発行
      BE->>BE: イベント検知
      BE->>DB: 報酬ステータスを「取得済み」に更新
      BE-->>FE: 更新通知
      FE-->>User: 報酬取得完了表示
    end
