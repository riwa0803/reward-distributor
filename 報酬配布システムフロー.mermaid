sequenceDiagram
    participant RP as 報酬提供者
    participant Admin as 管理者
    participant BE as バックエンド
    participant DB as データベース
    participant BC as ブロックチェーン
    participant User as ユーザー
    participant FE as フロントエンド
    participant Wallet as ウォレット

    %% Airdrop設定フェーズ
    rect rgb(230, 240, 255)
      note over Admin, DB: Airdrop設定フェーズ
      Admin->>BE: Airdrop情報登録(名前、説明、期間等)
      BE->>DB: Airdrop情報保存
      BE-->>Admin: AirdropID発行
    end

    %% アセット登録フェーズ
    rect rgb(240, 248, 255)
      note over RP, BC: アセット登録フェーズ
      RP->>BC: ERC20/721/1155トークンをMint
      RP->>BC: トークン転送の承認(Approve)
      Admin->>BC: registerAsset(tokenAddress, assetType, provider)
      BC-->>Admin: assetId発行
    end

    %% 報酬設定フェーズ
    rect rgb(255, 240, 240)
      note over RP, BC: オンチェーン報酬設定フェーズ
      RP->>BC: registerRewardWithAirdrop(assetId, airdropId, recipient, amount, tokenId)
      BC->>BC: 報酬コミットメント登録
      BC-->>BE: RewardRegisteredイベント発行
      BE->>BE: イベント検知
      BE->>DB: 報酬情報を保存(airdropId, assetId, recipient, amount, tokenId)
    end

    %% 報酬表示フェーズ
    rect rgb(255, 255, 240)
      note over User, FE: 報酬表示フェーズ
      User->>FE: 報酬一覧ページにアクセス
      FE->>BE: 報酬情報リクエスト(userAddress)
      BE->>DB: ユーザー向け報酬をクエリ
      BE->>BC: オンチェーンの取得状態確認
      BC-->>BE: 各報酬の取得状態(claimed)
      BE->>BE: DB状態とブロックチェーン状態を同期
      BE-->>FE: 報酬一覧+取得状態を返却
      FE-->>User: Airdropごとに報酬を表示
    end

    %% 報酬請求準備フェーズ
    rect rgb(240, 255, 240)
      note over User, Wallet: 報酬請求準備フェーズ
      User->>FE: 報酬請求ボタンをクリック
      FE->>BE: 請求準備リクエスト(airdropId, assetId, rewardId)
      BE->>BC: ユーザーのノンス値取得
      BC-->>BE: ノンス値
      BE->>BE: 署名生成(chainId, userAddress, assetId, rewardId, nonce)
      BE->>DB: 署名を記録
      BE-->>FE: 署名データとパラメータ返却
    end

    %% 報酬受取フェーズ
    rect rgb(240, 240, 255)
      note over User, DB: 報酬受取フェーズ
      FE->>Wallet: claimReward呼び出し要求
      Wallet->>BC: claimReward(chainId, assetId, rewardId, nonce, signature, amount, tokenId)
      BC->>BC: 署名検証
      BC->>BC: 取得済み状態の確認
      BC->>BC: 報酬パラメータの検証
      BC->>RP: transferFrom呼び出し
      RP-->>User: トークン転送
      BC->>BC: 報酬を取得済みとしてマーク
      BC-->>BE: RewardClaimedイベント発行
      BE->>BE: イベント検知
      BE->>DB: 報酬ステータスを「取得済み」に更新
      BE-->>FE: 更新通知（WebSocket等）
      FE-->>User: 報酬取得完了表示
    end

    %% 定期整合性確認フェーズ
    rect rgb(250, 235, 255)
      note over BE, BC: 定期整合性確認フェーズ
      BE->>BC: 全報酬の取得状態確認
      BC-->>BE: オンチェーンの最新状態
      BE->>DB: 取得状態の差分を更新
    end